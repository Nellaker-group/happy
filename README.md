# Histology Analysis Pipeline.py (HAPPY)

## Overview

Accompanying repository for *HAPPY: A deep learning pipeline for mapping cell-to-tissue 
graphs across placenta histology whole slide images*.

This repo contains all code for training, evaluating, and running inference across 
WSIs using the three stage deep learning pipeline detailed in the paper. The three 
deep learning steps are: nuclei detection, cell classification and tissue 
classification.

## Installation

Our codebase is writen in python=3.7.2. 

We recommend installation from source using the MakeFile which will install all 
requirements:

```bash
git clone git@github.com:Nellaker-group/happy.git
cd placenta
# Activate conda or venv environment with python installation:
# e.g. conda create -y -n happy python=3.7.2
#      conda activate happy
make environment_cu113
```
The make command will run the following:

```bash
pip install torch==1.11.0+cu113 torchvision==0.12.0+cu113 torchaudio==0.11.0 --extra-index-url https://download.pytorch.org/whl/cu113
pip install torch-scatter torch-sparse torch-cluster torch-spline-conv torch-geometric==2.0.4 -f https://data.pyg.org/whl/torch-1.11.0+cu113.html
pip install -r requirements.txt
pip install pyvips==2.1.14
pip install -e .
```
If you would rather install a different version of pytorch for your cuda version, 
please change the first two lines as per library instructions.

## Project Setup

The core code is organ-agnostic and may be used for any organ histology analysis. 
Organ-specific cell and tissue data may be added to `happy/organs.py`. We recommend
extending the core happy code by adding a new project to `projects/{project_name}`, 
using `projects/placenta` as a template.

If you would like to use the placenta histology data from the paper, you may download
the data from [this link](https://drive.google.com/drive/folders/1RvSQOxsWyUHf_SGV1Jzqa_Gc5QI4wQoy?usp=sharing). 
Keeping the same directory structure as in the link, place each directory into 
`projects/placenta`.

## Training

### Nuclei Detection Training

### Cell Classification Training

### Tissue Classification Training

## Evaluation

### Nuclei Detection Evaluation

### Cell Classification Evaluation

### Tissue Classification Evaluation

## WSI Inference Pipeline

### Adding WSIs to the Database

### Adding Trained Models to the Database

### Cell Pipeline

### Tissue Pipeline

## Visualisation

Along with the visualisation generated by `graph_inference.py`, we also provide scripts
for visualising nuclei ground truth over training data in 
`analysis/evaluation/vis_nuclei_predictions.py`, nuclei predictions over images in the 
training data in `analysis/evaluation/vis_groundtruth_nuclei.py`, regions of the cell
graph in `analysis/evaluation/vis_graph_patch.py`, and the ground truth tissue points 
in `analysis/evaluation/vis_groundtruth_graph.py`.